承知いたしました。いただいた追加要件をすべて反映し、要件定義書を最終版として更新しました。

---

## LINE BOT開発 要件定義書（最終版）

### 1. プロジェクト概要

| 項目 | 内容 |
| :--- | :--- |
| プロジェクト名 | LINE トリマー向けAIチャットボット サブスクリプション機能追加開発 |
| 目的 | 既存のLINE AIチャットボットにサブスクリプション機能を実装し、収益化及び有料/無料ユーザーの区分管理を実現する。簡易な相談対応をAIで代替し、メンバーの工数削減を目指す。 |
| 開発期間目安 | 2025年9月末リリースを目標とするが、工数により再調整の可能性あり。 |

### 2. 前提条件と制約事項

#### 2.1 既存システム環境
*   **フロントエンド**：LINE公式アカウント
*   **AIエンジン/連携ツール**：Difyを利用
*   **AIモデル**：OpenAI APIと連携済み
*   **Web検索機能**：Tavily Search連携済みだが、動作が不安定。

#### 2.2 開発範囲の前提
1.  Difyの「Line Bot」プラグインではユーザー管理が困難なため、**ユーザー情報、利用履歴、セッションを管理する新規バックエンドの構築**を必須とする。
2.  課金システムとしてStripeを利用する。
3.  **LLMの回答精度向上施策検討・実装（プロンプトチューニング、RAGデータの調整など）は本開発スコープ外**とする。

#### 2.3 サービスモデル
*   **ターゲット**：トリミングサロン、トリマー
*   **プラン構成**：フリーミアムモデル
    *   **無料プラン（Free）**：月間10回までの利用制限あり（毎月リセット）。
    *   **有料プラン（Premium）**：利用回数無制限。

### 3. システム構成概要（To Be）

| コンポーネント | 役割 | 備考 |
| :--- | :--- | :--- |
| **LINE Platform** | ユーザーとの接点、通知、リッチメニュー表示 | 既存利用 |
| **APIサーバー (Netlify)** | **新規開発領域の中核**。LINE Webhook受信、ユーザー認証、プラン・利用回数確認、Stripe連携、Difyへのリクエスト分岐制御、Googleスプレッドシートへのデータ記録を行う。 |
| **Google スプレッドシート** | **データベース代替**。運用管理者がユーザーデータ（プラン状況、利用回数等）を容易に確認できるよう、データベースの代わりに利用する。 |
| **Stripe** | 決済処理、サブスクリプション管理、**カスタマーポータル提供** | 連携必須 |
| **Dify Platform** | LLMとの連携、プロンプト管理、既存のAIロジック実行 | 既存利用 |

### 4. 機能要件詳細

#### 4.1 ユーザー管理機能

| ID | 機能名 | 詳細・要件 |
| :--- | :--- | :--- |
| U-101 | LINE ID連携・認証 | ユーザーがBOTを利用開始した際、LINE IDをベースにシステム側DB（スプレッドシート）にユーザー情報を登録・識別できるようにする。 |
| U-102 | ユーザー属性管理 | ユーザーの情報をGoogleスプレッドシートで管理する。<br>**保存項目:** LINEニックネーム, ユーザーID, Dify会話ID, プラン区分(有料/無料), 当月会話カウント, 契約日, 最終利用日。 |

#### 4.2 課金管理機能（Stripe連携）

| ID | 機能名 | 詳細・要件 |
| :--- | :--- | :--- |
| P-201 | 決済導線提供 | LINE BOTのリッチメニューやメッセージ内に、Stripe決済ページへ誘導するURLを設置する。 |
| P-202 | Stripe Checkout連携 | ユーザーが有料プランを購入するための決済画面をStripe Checkoutで実装する。 |
| P-203 | Webhook連携 | Stripeからの決済成功、失敗、サブスクリプション更新、キャンセルなどのイベントをAPIサーバーがリアルタイムで受信し、スプレッドシートのプラン情報を更新する。 |
| P-204 | サブスク状態同期 | 課金状態に応じて、ユーザーのプランを「有料」「無料」に正しく反映させる。解約・失敗時は自動的に無料プランへ移行させるロジックを実装する。 |
| P-205 | **サブスクリプション管理ポータル連携** | ユーザーが自身の契約状況の確認や解約手続きを行えるよう、**Stripeカスタマーポータル**へのリンクをLINE BOT内に設置する。 |

#### 4.3 BOT連携・利用制限機能

| ID | 機能名 | 詳細・要件 |
| :--- | :--- | :--- |
| B-301 | 利用回数管理 | 無料ユーザーのリクエスト発生ごとに、利用回数カウンターをインクリメントしスプレッドシートに記録する。 |
| B-302 | 月次リセット機能 | **毎月1日 00:00**に、全無料ユーザーの利用回数カウンターを一括でリセットする処理を実装する。（個別ユーザーごとのリセットタイミングは設けない） |
| B-303 | リクエスト分岐制御 | ユーザーからのメッセージ受信時、まずスプレッドシートを参照し、ユーザーのプランと利用回数を確認する。利用制限超過時（無料ユーザー）は、Difyへのリクエストをブロックする。 |
| B-304 | セッション/文脈維持 | LINE IDと対応するDify会話IDを連携ロジック側で管理し、Dify側に引き渡すことで、文脈を継続した会話を可能にする。 |
| B-305 | **Tavily Search安定化（努力義務）** | 既存のTavily Searchの動作安定化を試みる。ただし、**解決を保証するものではなく**、状況によっては代替機能の検討を提案する場合がある。 |

#### 4.4 ユーザー通知・有料化促進機能

| ID | 機能名 | 詳細・要件 |
| :--- | :--- | :--- |
| N-401 | 利用制限超過通知 | 無料ユーザーが利用回数を使い切った際、制限に達した旨を通知し、有料プランへの登録を促すメッセージ（URL付き）を自動送信する。 |
| N-402 | リッチメニュー設計 | LINEのリッチメニューに「有料プランへ登録」「**契約状況の確認/解約**」などの導線を設置する。 |

### 5. 非機能要件

| 項目 | 要件 |
| :--- | :--- |
| **セキュリティ** | Stripe連携のセキュリティ（Webhook検証、APIキー管理）を確保する。 |
| **既存LINE連携ツールとの競合** | Lステップやエルメなどのサードパーティ製ツールを導入済みの場合、LINEのWebhook URLは一つしか設定できないため**併用は不可**となる。本システム導入時には、既存ツールのWebhook連携を解除する必要がある。 |
| **パフォーマンス/スケーラビリティ** | Googleスプレッドシートをデータベースとして利用するため、API呼び出し回数制限や同時アクセス時のパフォーマンスに制約が生じる可能性がある。将来的なユーザー数の増加を見越して、RDBへの移行も視野に入れることを推奨する。 |
| **法令遵守** | 特定商取引法に基づく表記ページの設置（クライアント側作業）が必要であることを改めて確認する。 |

### 6. スコープ外事項

本プロジェクトのスコープに含まれない事項は以下の通りです。
1.  **LLMの回答精度に関する調整**：プロンプト内容の調整、RAGによる知識付与、AI回答内容の妥当性検証・修正。
2.  **Stripe決済後の遷移ページの作成**：決済成功後に表示されるサンクスページや、決済をキャンセルした際のキャンセルページのWebページ制作。これらのURLはStripe側に設定する必要がある。
3.  **LINE公式アカウントのプロモーション**：友だち追加施策、広告運用など。
4.  **Stripeアカウントの本番審査手続き**：事業者情報登録や本人確認書類提出などのStripe側手続き。
5.  **特定商取引法に基づく表記ページの制作**。（決済導線として外部ページへのリンク提供はスコープ内）

### 7. 技術実装方針

| 項目 | 実装方針 | 備考 |
| :--- | :--- | :--- |
| **バックエンド/デプロイ** | **Netlify Functions**を利用。 | Stripe Webhookが要求する即時応答（HTTP 200）と、GAS利用時の302リダイレクト問題を回避する。 |
| **データベース** | **Googleスプレッドシート**を利用。 | Google Sheets API経由でデータの読み書きを行う。 |
| **プログラミング言語** | Node.js (JavaScript/TypeScript) を想定。 | Netlify Functionsとの親和性が高い。 |
| **Stripe連携** | **Stripe Checkout**による決済セッション作成。<br>**Stripe Customer Portal**によるサブスクリプション管理。<br>**Stripe Webhook**によるイベント受信。 |
| **Dify連携** | バックエンドからDifyのConversation APIを呼び出す。 |
| **定期処理（バッチ）** | **Netlify Scheduled Functions**を利用。 | 毎月1日 00:00にスプレッドシートの利用回数カウンターをリセットする処理を自動実行する。 |